<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPS Asset Management Dashboard</title>
    
    <!-- LOCAL CSS - Using existing resources from parent folder -->
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="../css/buttons.bootstrap5.min.css">
    
    <style>
        :root {
            --primary: #0f5b9c;
            --primary-dark: #1a4b7a;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
        }
        
        body {
            background: #f0f5fa;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            padding: 24px;
            color: #1e293b;
        }
        
        .dashboard-wrapper {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Header */
        .header-card {
            background: white;
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-title i {
            font-size: 2rem;
            color: var(--primary);
            background: #e8f0fe;
            padding: 15px;
            border-radius: 16px;
        }
        
        .header-title h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: #1a4b7a;
        }
        
        .live-badge {
            background: #e8f7ed;
            color: #0b5e42;
            padding: 10px 20px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #a3e0b6;
        }
        
        .live-badge i {
            font-size: 0.7rem;
            color: #10b981;
        }
        
        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            background: white;
            border-radius: 18px;
            padding: 22px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 18px;
            transition: all 0.2s;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(15, 91, 156, 0.1);
        }
        
        .stat-icon {
            width: 55px;
            height: 55px;
            background: #e8f0fe;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.6rem;
        }
        
        .stat-info h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            color: #1e293b;
            line-height: 1.2;
        }
        
        .stat-info p {
            margin: 5px 0 0;
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* Control Panel */
        .control-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        
        .control-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #1a4b7a;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .control-title i {
            color: var(--primary);
        }
        
        .column-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .toggle-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 8px 18px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-btn i {
            font-size: 0.8rem;
            color: #94a3b8;
        }
        
        .toggle-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .toggle-btn.active i {
            color: white;
        }

        /* Backup filter dropdown */
        .backup-filter-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 16px;
            background: #f8fafc;
            border-radius: 40px;
            border: 1px solid #e9ecef;
        }
        
        .backup-filter-label {
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .backup-filter-label i {
            color: var(--primary);
        }
        
        .backup-filter-select {
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 8px 32px 8px 18px;
            background: white;
            font-size: 0.9rem;
            min-width: 240px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23334155' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 14px;
        }
        
        .backup-filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(15, 91, 156, 0.1);
        }
        
        .btn-clear {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 8px 20px;
            color: #64748b;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-clear:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #ef4444;
        }
        
        .btn-clear i {
            margin-right: 6px;
        }
        
        .export-btns {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 8px 22px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            background: white;
            transition: all 0.2s;
            text-decoration: none;
            color: #475569;
        }
        
        .export-btn.excel:hover {
            background: #e8f7ed;
            border-color: #10b981;
            color: #0b5e42;
        }
        
        .export-btn.pdf:hover {
            background: #fee9e7;
            border-color: #ef4444;
            color: #b91c1c;
        }
        
        .export-btn.csv:hover {
            background: #e8f0fe;
            border-color: var(--primary);
            color: var(--primary);
        }

        .export-btn.print:hover {
            background: #f1f4f9;
            border-color: #64748b;
            color: #1e293b;
        }
        
        /* Table Card */
        .table-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        
        /* Loading */
        .loading-wrapper {
            text-align: center;
            padding: 60px;
        }
        
        .spinner {
            width: 45px;
            height: 45px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        /* Table Styling */
        #upsTable {
            margin-top: 10px !important;
            border: 1px solid #e9ecef;
            border-radius: 16px;
            overflow: hidden;
        }
        
        #upsTable thead th {
            background: linear-gradient(135deg, #0f5b9c 0%, #1a4b7a 100%);
            color: white;
            font-weight: 500;
            font-size: 0.85rem;
            padding: 16px 12px;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        
        #upsTable thead th:last-child {
            border-right: none;
        }
        
        #upsTable tbody td {
            padding: 14px 12px;
            vertical-align: middle;
            border-bottom: 1px solid #edf2f7;
            color: #1e293b;
        }
        
        #upsTable tbody tr:hover td {
            background: #f0f7ff;
        }
        
        /* Badges */
        .status-badge {
            padding: 5px 14px;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .badge-amc {
            background: #e8f7ed;
            color: #0b5e42;
            border: 1px solid #a3e0b6;
        }
        
        .badge-nonamc {
            background: #fee9e7;
            color: #b91c1c;
            border: 1px solid #f1aeb5;
        }
        
        .badge-working {
            background: #e8f7ed;
            color: #0b5e42;
            border: 1px solid #a3e0b6;
        }
        
        .badge-notworking {
            background: #fee9e7;
            color: #b91c1c;
            border: 1px solid #f1aeb5;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .age-chip {
            background: #f1f4f9;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #475569;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .doc-btn {
            background: #e8f0fe;
            color: var(--primary);
            border: 1px solid #b8d4fe;
            padding: 5px 14px;
            border-radius: 25px;
            font-size: 0.75rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .doc-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* DataTables Custom */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 20px;
        }
        
        .dataTables_filter input {
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 8px 16px 8px 38px;
            margin-left: 8px;
            outline: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 12px center;
        }
        
        .dataTables_filter input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(15, 91, 156, 0.1);
        }
        
        .dataTables_length select {
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 6px 25px 6px 12px;
        }
        
        .dataTables_info {
            color: #64748b;
            font-size: 0.9rem;
            padding-top: 15px;
        }
        
        .dataTables_paginate {
            margin-top: 20px;
        }
        
        .dataTables_paginate .paginate_button {
            border-radius: 30px;
            margin: 0 3px;
            border: 1px solid #e2e8f0;
            color: #1e293b !important;
        }
        
        .dataTables_paginate .paginate_button.current {
            background: var(--primary) !important;
            border-color: var(--primary) !important;
            color: white !important;
        }
        
        .dataTables_paginate .paginate_button:hover {
            background: #f1f5f9 !important;
            border-color: #cbd5e1 !important;
            color: var(--primary) !important;
        }
        
        /* Hide default DataTables buttons but keep them functional */
        .dt-buttons {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            body { padding: 16px; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .header-card { flex-direction: column; gap: 15px; }
            .export-btns { justify-content: center; }
            .backup-filter-group { flex-direction: column; align-items: stretch; }
            .backup-filter-select { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Header -->
        <div class="header-card">
            <div class="header-title">
                <i class="bi bi-battery-charging"></i>
                <div>
                    <h1>UPS Backup Status</h1>
                    <p class="text-muted mb-0 mt-1">Asset Management Dashboard</p>
                </div>
            </div>
            <div class="live-badge" id="liveIndicator">
                <i class="bi bi-circle-fill"></i>
                <span>Loading data...</span>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-row" id="statsRow">
            <div class="stat-item">
                <div class="stat-icon"><i class="bi bi-hdd-stack"></i></div>
                <div class="stat-info">
                    <h3 id="totalUps">0</h3>
                    <p>Total UPS Units</p>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon"><i class="bi bi-building"></i></div>
                <div class="stat-info">
                    <h3 id="totalTreasuries">0</h3>
                    <p>Treasuries</p>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                <div class="stat-info">
                    <h3 id="noBackup">0</h3>
                    <p>No Backup</p>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon"><i class="bi bi-file-text"></i></div>
                <div class="stat-info">
                    <h3 id="withDocs">0</h3>
                    <p>Documents Uploaded</p>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="control-card">
            <div class="control-title">
                <i class="bi bi-sliders"></i>
                <span>Table Controls</span>
            </div>
            
            <!-- Backup Condition Filter Dropdown -->
            <div class="backup-filter-group">
                <span class="backup-filter-label">
                    <i class="bi bi-filter"></i> Filter by Backup Condition:
                </span>
                <select id="backupConditionFilter" class="backup-filter-select">
                    <option value="">All Conditions</option>
                </select>
                <button id="clearBackupFilter" class="btn-clear">
                    <i class="bi bi-x"></i> Clear
                </button>
            </div>
            
            <div class="row align-items-center">
                <div class="col-lg-7">
                    <div class="column-toggles" id="columnToggles">
                        <!-- Dynamic toggles will appear here -->
                    </div>
                </div>
                <div class="col-lg-5">
                    <!-- Custom export buttons -->
                    <div class="export-btns" id="exportButtons">
                        <button class="export-btn excel" id="exportExcelBtn"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                        <button class="export-btn pdf" id="exportPdfBtn"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
                        <button class="export-btn csv" id="exportCsvBtn"><i class="bi bi-file-earmark-spreadsheet"></i> CSV</button>
                        <button class="export-btn print" id="exportPrintBtn"><i class="bi bi-printer"></i> Print</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Card -->
        <div class="table-card">
            <div id="loadingSpinner" class="loading-wrapper">
                <div class="spinner"></div>
                <p class="text-muted">Loading UPS inventory data...</p>
            </div>
            
            <div id="tableContainer" style="display: none;">
                <table id="upsTable" class="table" style="width:100%">
                    <thead>
                        <tr>
                            <th>Treasury Name</th>
                            <th>Asset ID</th>
                            <th>Model</th>
                            <th>Serial Number</th>
                            <th>Install Date</th>
                            <th>Warranty Upto</th>
                            <th>Contract</th>
                            <th>Age</th>
                            <th>Backup Condition</th>
                            <th>Reason (if any)</th>
                            <th>Certificate</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- LOCAL SCRIPTS -->
    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.bundle.min.js"></script>
    
    <!-- DataTables Core -->
    <script src="../js/jquery.dataTables.min.js"></script>
    <script src="../js/dataTables.bootstrap5.min.js"></script>
    
    <!-- DataTables Buttons & Dependencies -->
    <script src="../js/dataTables.buttons.min.js"></script>
    <script src="../js/buttons.bootstrap5.min.js"></script>
    <script src="../js/jszip.min.js"></script>
    <script src="../js/pdfmake.min.js"></script>
    <script src="../js/vfs_fonts.js"></script>
    <script src="../js/buttons.html5.min.js"></script>
    <script src="../js/buttons.print.min.js"></script>

    <script>
        // ==================== CONFIGURATION ====================
        const API_KEY = 'AIzaSyBB1V3vJpNZ9X1GIF-YOwoa6YSt_iXMLo0';
        const SPREADSHEET_ID = '1zpoE3tVNX8GuHENtTj3uOXNQVHBtrGytKEO75XsyEl4';
        const SHEET_NAME = 'Data';
        
        // Global variables
        let upsData = [];
        let dataTable = null;
        let tableInitialized = false;
        
        // Column definitions
        const columnDefs = [
            { title: 'Treasury Name', data: 'treasury', visible: true },
            { title: 'Asset ID', data: 'assetId', visible: true },
            { title: 'Model', data: 'model', visible: true },
            { title: 'Serial Number', data: 'serialNo', visible: true },
            { title: 'Install Date', data: 'installDate', visible: true },
            { title: 'Warranty Upto', data: 'warranty', visible: true },
            { title: 'Contract', data: 'contractStatus', visible: true },
            { title: 'Age', data: 'age', visible: true },
            { title: 'Backup Condition', data: 'backupCondition', visible: true },
            { title: 'Reason', data: 'backupReason', visible: true },
            { title: 'Certificate', data: 'document', visible: true }
        ];

        // ==================== MAIN ====================
        $(document).ready(function() {
            console.log('Document ready, loading data...');
            loadSheetData();

            // Export button listeners (trigger DataTables buttons)
            $('#exportExcelBtn').on('click', function() { 
                if (dataTable) $('.buttons-excel').first().trigger('click'); 
            });
            $('#exportPdfBtn').on('click', function() { 
                if (dataTable) $('.buttons-pdf').first().trigger('click'); 
            });
            $('#exportCsvBtn').on('click', function() { 
                if (dataTable) $('.buttons-csv').first().trigger('click'); 
            });
            $('#exportPrintBtn').on('click', function() { 
                if (dataTable) $('.buttons-print').first().trigger('click'); 
            });

            // Backup filter change event
            $('#backupConditionFilter').on('change', function() {
                if (dataTable) {
                    const searchValue = this.value;
                    dataTable.column(8).search(searchValue).draw();
                }
            });

            // Clear backup filter
            $('#clearBackupFilter').on('click', function() {
                $('#backupConditionFilter').val('');
                if (dataTable) {
                    dataTable.column(8).search('').draw();
                }
            });
        });

        async function loadSheetData() {
            try {
                showLoading(true);
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(SHEET_NAME)}?key=${API_KEY}`;
                console.log('Fetching from:', url);
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('Data received:', data);
                
                if (!data.values || data.values.length < 2) {
                    throw new Error('No data rows found');
                }

                processData(data.values);
                updateLiveIndicator();
                updateStats();
                initializeTable();
                createColumnToggles();
                populateBackupFilter();
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error:', error);
                $('#loadingSpinner').html(`
                    <i class="bi bi-exclamation-triangle-fill fa-3x text-danger mb-3"></i>
                    <h5 class="text-danger">Failed to load data</h5>
                    <p class="text-muted">${error.message}</p>
                    <button class="btn btn-primary mt-3" onclick="location.reload()">
                        <i class="bi bi-arrow-repeat"></i> Retry
                    </button>
                `);
            }
        }

        function processData(rows) {
            upsData = [];
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 5) continue;
                
                const years = row[8] || '0';
                const months = row[9] || '0';
                const days = row[10] || '0';
                
                let ageStr = '';
                if (years && years !== '0') ageStr += `${years}Y `;
                if (months && months !== '0') ageStr += `${months}M `;
                if (days && days !== '0') ageStr += `${days}D`;
                if (!ageStr.trim()) ageStr = 'New';
                
                upsData.push({
                    treasury: row[0] || '—',
                    assetId: row[1] || '—',
                    model: row[2] || '—',
                    serialNo: row[3] || '—',
                    installDate: formatDate(row[4]),
                    warranty: formatDate(row[5]),
                    contractStatus: row[6] || '—',
                    poNumber: row[7] || '—',
                    age: ageStr,
                    backupCondition: row[11] || '—',
                    backupReason: row[12] || '—',
                    document: row[13] || ''
                });
            }
            
            console.log(`Processed ${upsData.length} records`);
        }

        function formatDate(date) {
            if (!date || date === '—') return '—';
            if (typeof date === 'string' && date.includes(' 00:00:00')) {
                return date.split(' ')[0];
            }
            return date;
        }

        function populateBackupFilter() {
            const conditions = new Set();
            upsData.forEach(item => {
                if (item.backupCondition && item.backupCondition !== '—') {
                    conditions.add(item.backupCondition);
                }
            });
            const sorted = Array.from(conditions).sort();
            const $select = $('#backupConditionFilter');
            $select.find('option:not(:first)').remove();
            sorted.forEach(cond => {
                $select.append($('<option>', {
                    value: cond,
                    text: cond
                }));
            });
        }

        function initializeTable() {
            if (dataTable) {
                dataTable.destroy();
                dataTable = null;
            }

            const tableData = upsData.map(item => [
                item.treasury,
                item.assetId,
                item.model,
                item.serialNo,
                item.installDate,
                item.warranty,
                item.contractStatus,
                item.age,
                item.backupCondition,
                item.backupReason,
                item.document
            ]);

            dataTable = $('#upsTable').DataTable({
                data: tableData,
                columns: columnDefs.map((col, idx) => ({
                    title: col.title,
                    visible: col.visible,
                    render: function(data, type, row) {
                        if (type === 'display') {
                            if (idx === 6) { // Contract
                                if (data === 'AMC') {
                                    return `<span class="status-badge badge-amc"><i class="bi bi-check-circle-fill me-1"></i>${data}</span>`;
                                } else if (data === 'NOT IN CONTRACT') {
                                    return `<span class="status-badge badge-nonamc"><i class="bi bi-exclamation-circle-fill me-1"></i>${data}</span>`;
                                }
                            }
                            else if (idx === 7) { // Age
                                if (data !== '—' && data !== 'New') {
                                    return `<span class="age-chip"><i class="bi bi-clock-history me-1"></i>${data}</span>`;
                                }
                                return `<span class="age-chip">${data}</span>`;
                            }
                            else if (idx === 8) { // Backup Condition
                                const lower = data.toLowerCase();
                                if (lower.includes('no backup')) {
                                    return `<span class="status-badge badge-notworking"><i class="bi bi-x-circle-fill me-1"></i>${data}</span>`;
                                } else if (lower.includes('hour') || lower.includes('backup')) {
                                    return `<span class="status-badge badge-working"><i class="bi bi-battery-half me-1"></i>${data}</span>`;
                                }
                                return data;
                            }
                            else if (idx === 10) { // Document
                                if (data && data.includes('http')) {
                                    return `<a href="${data}" target="_blank" class="doc-btn"><i class="bi bi-box-arrow-up-right"></i> View</a>`;
                                } else {
                                    return `<span class="text-muted"><i class="bi bi-file-earmark"></i> No doc</span>`;
                                }
                            }
                        }
                        return data;
                    }
                })),
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                order: [[0, 'asc']],
                dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>rtip',
                buttons: [
                    { 
                        extend: 'excelHtml5', 
                        text: 'Excel', 
                        className: 'btn btn-sm buttons-excel',
                        exportOptions: { 
                            columns: ':visible', 
                            format: { 
                                body: function(data) {
                                    return $('<div>').html(data).text().trim() || data;
                                }
                            } 
                        } 
                    },
                    { 
                        extend: 'pdfHtml5', 
                        text: 'PDF', 
                        className: 'btn btn-sm buttons-pdf', 
                        orientation: 'landscape', 
                        pageSize: 'A4', 
                        exportOptions: { 
                            columns: ':visible', 
                            format: { 
                                body: function(data) {
                                    return $('<div>').html(data).text().trim() || data;
                                }
                            } 
                        } 
                    },
                    { 
                        extend: 'csvHtml5', 
                        text: 'CSV', 
                        className: 'btn btn-sm buttons-csv', 
                        exportOptions: { 
                            columns: ':visible', 
                            format: { 
                                body: function(data) {
                                    return $('<div>').html(data).text().trim() || data;
                                }
                            } 
                        } 
                    },
                    { 
                        extend: 'print', 
                        text: 'Print', 
                        className: 'btn btn-sm buttons-print', 
                        exportOptions: { 
                            columns: ':visible', 
                            format: { 
                                body: function(data) {
                                    return $('<div>').html(data).text().trim() || data;
                                }
                            } 
                        } 
                    }
                ],
                language: {
                    search: "Search:",
                    searchPlaceholder: "Filter records...",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "Showing 0 to 0 of 0 entries",
                    infoFiltered: "(filtered from _MAX_ total entries)",
                    paginate: {
                        first: '<i class="bi bi-chevron-double-left"></i>',
                        previous: '<i class="bi bi-chevron-left"></i>',
                        next: '<i class="bi bi-chevron-right"></i>',
                        last: '<i class="bi bi-chevron-double-right"></i>'
                    }
                }
            });

            tableInitialized = true;
            console.log('Table initialized');
        }

        function createColumnToggles() {
            const container = $('#columnToggles');
            container.empty();
            
            columnDefs.forEach((col, index) => {
                const btn = $(`
                    <span class="toggle-btn active" data-col="${index}">
                        <i class="bi bi-check-circle-fill"></i> ${col.title}
                    </span>
                `);
                
                btn.click(function() {
                    if (dataTable) {
                        const column = dataTable.column(index);
                        const visible = column.visible();
                        column.visible(!visible);
                        if ($(this).hasClass('active')) {
                            $(this).removeClass('active');
                            $(this).find('i').removeClass('bi-check-circle-fill').addClass('bi-circle');
                        } else {
                            $(this).addClass('active');
                            $(this).find('i').removeClass('bi-circle').addClass('bi-check-circle-fill');
                        }
                    }
                });
                container.append(btn);
            });
        }

        function updateStats() {
            $('#totalUps').text(upsData.length);
            const treasuries = new Set(upsData.map(item => item.treasury)).size;
            $('#totalTreasuries').text(treasuries);
            const noBackup = upsData.filter(item => item.backupCondition && item.backupCondition.toLowerCase().includes('no backup')).length;
            $('#noBackup').text(noBackup);
            const withDocs = upsData.filter(item => item.document && item.document.includes('http')).length;
            $('#withDocs').text(withDocs);
        }

        function updateLiveIndicator() {
            $('#liveIndicator').html(`
                <i class="bi bi-circle-fill" style="color:#10b981;"></i>
                <span>Updated ${new Date().toLocaleTimeString()}</span>
            `);
        }

        function showLoading(show) {
            if (show) {
                $('#loadingSpinner').show();
                $('#tableContainer').hide();
            } else {
                $('#loadingSpinner').hide();
                $('#tableContainer').show();
            }
        }
    </script>
</body>
</html>