<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPS Asset Management Dashboard</title>
    
    <!-- Bootstrap 5 Light Theme -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <!-- Buttons for Export -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --light-bg: #f8f9fa;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.05);
            --border-radius: 16px;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 24px;
            min-height: 100vh;
        }
        
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Header Styles */
        .app-header {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px 28px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.03);
        }
        
        .app-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2b2d42;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .app-header h1 i {
            color: var(--primary-color);
            background: rgba(67, 97, 238, 0.1);
            padding: 12px;
            border-radius: 14px;
        }
        
        .badge-live {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #a5d6a7;
        }
        
        .badge-live i {
            font-size: 0.6rem;
            color: #4caf50;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0,0,0,0.03);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1.4rem;
        }
        
        .stat-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2b2d42;
            margin: 0;
            line-height: 1.2;
        }
        
        .stat-content p {
            color: #6c757d;
            margin: 0;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* Control Panel */
        .control-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0,0,0,0.03);
        }
        
        .panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            color: #2b2d42;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .panel-title i {
            color: var(--primary-color);
        }
        
        .column-toggle {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        
        .toggle-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 30px;
            padding: 6px 14px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .toggle-item:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .toggle-item.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .toggle-item i {
            font-size: 0.75rem;
        }
        
        .btn-group-custom {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-export {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 30px;
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #495057;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .btn-export:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
            color: #212529;
        }
        
        .btn-export.excel:hover {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .btn-export.pdf:hover {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        
        .btn-export.csv:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1565c0;
        }
        
        /* Table Container */
        .table-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0,0,0,0.03);
        }
        
        /* DataTables Customization */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            margin-bottom: 16px;
        }
        
        .dataTables_wrapper .dataTables_filter input {
            border: 1px solid #dee2e6;
            border-radius: 30px;
            padding: 8px 16px;
            margin-left: 8px;
        }
        
        .dataTables_wrapper .dataTables_length select {
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 6px 24px 6px 12px;
        }
        
        table.dataTable {
            border-collapse: separate !important;
            border-spacing: 0 8px !important;
            margin-top: 0 !important;
        }
        
        table.dataTable thead th {
            background: #f8f9fa;
            color: #2b2d42;
            font-weight: 600;
            font-size: 0.85rem;
            padding: 14px 12px;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }
        
        table.dataTable tbody td {
            padding: 14px 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-width: 1px 0;
            vertical-align: middle;
        }
        
        table.dataTable tbody tr {
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            transition: all 0.2s;
        }
        
        table.dataTable tbody tr:hover td {
            background: #f8f9fa;
        }
        
        .badge-status {
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-working {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        
        .badge-warning {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffcc80;
        }
        
        .badge-danger {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        .badge-info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }
        
        .btn-view {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(67, 97, 238, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .btn-view:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .age-badge {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }
        
        /* Loading State */
        .loading-overlay {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 16px;
        }
        
        .spinner-custom {
            width: 40px;
            height: 40px;
            border: 3px solid #e9ecef;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Select2 Custom */
        .select2-container--bootstrap-5 .select2-selection {
            border-radius: 30px;
            padding: 4px 12px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 12px; }
            .app-header { flex-direction: column; gap: 12px; text-align: center; }
            .column-toggle { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="app-header">
            <h1>
                <i class="fas fa-bolt"></i>
                UPS Asset Management
            </h1>
            <div class="badge-live">
                <i class="fas fa-circle"></i>
                <span id="liveTimestamp">Loading data...</span>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid" id="statsContainer">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-server"></i></div>
                <div class="stat-content">
                    <h3 id="totalUPS">0</h3>
                    <p>Total UPS Units</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-building"></i></div>
                <div class="stat-content">
                    <h3 id="totalTreasuries">0</h3>
                    <p>Treasuries</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-content">
                    <h3 id="noBackup">0</h3>
                    <p>No Backup</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-file-pdf"></i></div>
                <div class="stat-content">
                    <h3 id="withDocs">0</h3>
                    <p>With Documents</p>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="panel-title">
                <i class="fas fa-sliders-h"></i>
                <span>Column Visibility & Export Controls</span>
            </div>
            
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="column-toggle" id="columnToggles">
                        <!-- Column toggles will be populated dynamically -->
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="btn-group-custom justify-content-end">
                        <a href="#" class="btn-export excel" id="exportExcel">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                        <a href="#" class="btn-export pdf" id="exportPDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <a href="#" class="btn-export csv" id="exportCSV">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="table-container">
            <div id="loadingSpinner" class="loading-overlay">
                <div class="spinner-custom"></div>
                <p class="text-muted">Fetching UPS data from Google Sheets...</p>
            </div>
            <div id="tableWrapper" style="display: none;">
                <table id="upsTable" class="table table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>Treasury</th>
                            <th>Asset ID</th>
                            <th>Model</th>
                            <th>Serial No.</th>
                            <th>Install Date</th>
                            <th>Warranty</th>
                            <th>Age (Y/M/D)</th>
                            <th>Status</th>
                            <th>Backup Condition</th>
                            <th>Reason (if no backup)</th>
                            <th>Document</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // Configuration
        const API_KEY = 'AIzaSyBB1V3vJpNZ9X1GIF-YOwoa6YSt_iXMLo0';
        const SPREADSHEET_ID = '1zpoE3tVNX8GuHENtTj3uOXNQVHBtrGytKEO75XsyEl4';
        const SHEET_NAME = 'Data'; // Assuming the sheet is named 'Data' as in the Excel
        
        let upsData = [];
        let dataTable;
        let columnDefinitions = [];

        // Column definitions for toggles
        const allColumns = [
            { data: 'treasury', title: 'Treasury', visible: true },
            { data: 'assetId', title: 'Asset ID', visible: true },
            { data: 'model', title: 'Model', visible: true },
            { data: 'serialNo', title: 'Serial No.', visible: true },
            { data: 'installDate', title: 'Install Date', visible: true },
            { data: 'warranty', title: 'Warranty', visible: true },
            { data: 'age', title: 'Age', visible: true },
            { data: 'contractStatus', title: 'Contract Status', visible: true },
            { data: 'backupCondition', title: 'Backup Condition', visible: true },
            { data: 'backupReason', title: 'Reason (if no backup)', visible: true },
            { data: 'document', title: 'Document', visible: true }
        ];

        $(document).ready(function() {
            loadUPSData();
        });

        async function loadUPSData() {
            try {
                // Show loading
                $('#loadingSpinner').show();
                $('#tableWrapper').hide();

                // Fetch data from Google Sheets
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                
                if (!data.values || data.values.length < 2) {
                    throw new Error('No data found in sheet');
                }

                // Process the data
                processSheetData(data.values);
                
                // Update timestamp
                document.getElementById('liveTimestamp').innerHTML = 
                    `<i class="fas fa-check-circle" style="color:#4caf50;"></i> Updated ${new Date().toLocaleTimeString()}`;
                
                // Hide loading, show table
                $('#loadingSpinner').hide();
                $('#tableWrapper').show();
                
                // Initialize DataTable
                initializeDataTable();
                
                // Create column toggles
                createColumnToggles();
                
                // Update stats
                updateStats();

            } catch (error) {
                console.error('Error loading data:', error);
                $('#loadingSpinner').html(`
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <h5 class="text-danger">Error Loading Data</h5>
                    <p class="text-muted">${error.message}</p>
                    <button class="btn btn-primary mt-3" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                `);
            }
        }

        function processSheetData(rows) {
            // Skip header row (index 0)
            const dataRows = rows.slice(1);
            
            upsData = dataRows.map(row => {
                // Map columns based on the Excel structure
                return {
                    treasury: row[0] || '—',
                    assetId: row[1] || '—',
                    model: row[2] || '—',
                    serialNo: row[3] || '—',
                    installDate: formatDate(row[4]),
                    warranty: formatDate(row[5]),
                    contractStatus: row[6] || '—',
                    poNumber: row[7] || '—',
                    ageYears: row[8] || '0',
                    ageMonths: row[9] || '0',
                    ageDays: row[10] || '0',
                    backupCondition: row[11] || '—',
                    backupReason: row[12] || '—',
                    document: row[13] || '',
                    // Calculated field for age display
                    age: `${row[8] || '0'}Y ${row[9] || '0'}M ${row[10] || '0'}D`
                };
            });
            
            console.log(`Loaded ${upsData.length} UPS records`);
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr === '—') return '—';
            // Handle various date formats
            if (dateStr.includes('00:00:00')) {
                return dateStr.split(' ')[0];
            }
            return dateStr;
        }

        function initializeDataTable() {
            if (dataTable) {
                dataTable.destroy();
            }

            dataTable = $('#upsTable').DataTable({
                data: upsData,
                columns: allColumns,
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                order: [[0, 'asc']],
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
                language: {
                    search: "_INPUT_",
                    searchPlaceholder: "Search UPS records..."
                },
                columnDefs: [
                    {
                        targets: 10, // Document column
                        render: function(data, type, row) {
                            if (!data || data === '—' || data === '') {
                                return '<span class="text-muted"><i class="far fa-file"></i> No doc</span>';
                            }
                            
                            // Check if it's a Google Drive URL
                            if (data.includes('drive.google.com') || data.includes('docs.google.com')) {
                                return `<a href="${data}" target="_blank" class="btn-view">
                                    <i class="fas fa-external-link-alt"></i> View
                                </a>`;
                            } else {
                                return `<a href="${data}" target="_blank" class="btn-view">
                                    <i class="fas fa-file-pdf"></i> View
                                </a>`;
                            }
                        }
                    },
                    {
                        targets: 7, // Contract Status
                        render: function(data, type, row) {
                            if (data === 'AMC') {
                                return `<span class="badge-status badge-working"><i class="fas fa-check-circle"></i> ${data}</span>`;
                            } else if (data === 'NOT IN CONTRACT') {
                                return `<span class="badge-status badge-danger"><i class="fas fa-exclamation-circle"></i> ${data}</span>`;
                            } else {
                                return `<span class="badge-status badge-info">${data}</span>`;
                            }
                        }
                    },
                    {
                        targets: 8, // Backup Condition
                        render: function(data, type, row) {
                            if (data && data.toLowerCase().includes('no backup')) {
                                return `<span class="badge-status badge-danger"><i class="fas fa-times-circle"></i> ${data}</span>`;
                            } else if (data && data.includes('hour')) {
                                return `<span class="badge-status badge-working"><i class="fas fa-battery-three-quarters"></i> ${data}</span>`;
                            } else if (data && data !== '—') {
                                return `<span class="badge-status badge-info">${data}</span>`;
                            }
                            return '<span class="text-muted">—</span>';
                        }
                    },
                    {
                        targets: 6, // Age
                        render: function(data, type, row) {
                            if (data === '0Y 0M 0D' || data === '—') return '—';
                            return `<span class="age-badge"><i class="far fa-clock"></i> ${data}</span>`;
                        }
                    }
                ],
                createdRow: function(row, data, dataIndex) {
                    // Add custom styling based on backup condition
                    if (data.backupCondition && data.backupCondition.toLowerCase().includes('no backup')) {
                        $(row).addClass('table-danger-light');
                    }
                }
            });
        }

        function createColumnToggles() {
            const container = $('#columnToggles');
            container.empty();
            
            allColumns.forEach((col, index) => {
                const toggle = $(`
                    <div class="toggle-item active" data-column="${index}">
                        <i class="fas fa-check-circle"></i>
                        ${col.title}
                    </div>
                `);
                
                toggle.click(function() {
                    const column = dataTable.column(index);
                    const isVisible = column.visible();
                    
                    column.visible(!isVisible);
                    
                    if (isVisible) {
                        $(this).removeClass('active');
                        $(this).find('i').removeClass('fa-check-circle').addClass('fa-circle');
                    } else {
                        $(this).addClass('active');
                        $(this).find('i').removeClass('fa-circle').addClass('fa-check-circle');
                    }
                });
                
                container.append(toggle);
            });
        }

        function updateStats() {
            // Total UPS
            $('#totalUPS').text(upsData.length);
            
            // Unique Treasuries
            const uniqueTreasuries = new Set(upsData.map(item => item.treasury)).size;
            $('#totalTreasuries').text(uniqueTreasuries);
            
            // No Backup count
            const noBackup = upsData.filter(item => 
                item.backupCondition && item.backupCondition.toLowerCase().includes('no backup')
            ).length;
            $('#noBackup').text(noBackup);
            
            // With Documents
            const withDocs = upsData.filter(item => 
                item.document && item.document !== '' && item.document !== '—'
            ).length;
            $('#withDocs').text(withDocs);
        }

        // Export handlers
        $('#exportExcel').click(function(e) {
            e.preventDefault();
            dataTable.button('.buttons-excel').trigger();
        });

        $('#exportPDF').click(function(e) {
            e.preventDefault();
            dataTable.button('.buttons-pdf').trigger();
        });

        $('#exportCSV').click(function(e) {
            e.preventDefault();
            dataTable.button('.buttons-csv').trigger();
        });

        // Add export buttons to DataTable
        $.fn.dataTable.ext.buttons.excel = {
            extend: 'excelHtml5',
            title: 'UPS_Asset_Report',
            exportOptions: {
                columns: ':visible'
            }
        };

        $.fn.dataTable.ext.buttons.pdf = {
            extend: 'pdfHtml5',
            title: 'UPS_Asset_Report',
            exportOptions: {
                columns: ':visible'
            },
            customize: function(doc) {
                doc.styles.title = {
                    color: '#4361ee',
                    fontSize: '18',
                    alignment: 'center'
                };
            }
        };

        $.fn.dataTable.ext.buttons.csv = {
            extend: 'csvHtml5',
            title: 'UPS_Asset_Report',
            exportOptions: {
                columns: ':visible'
            }
        };
    </script>
</body>
</html>
