<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPLS District Wise View</title>
    
    <!-- LOCAL CSS - Using existing resources from parent folder -->
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="../css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="../css/select2.min.css">
    <link rel="stylesheet" href="../css/select2-bootstrap-5-theme.min.css">
    
    <style>
        :root {
            --primary: #0f5b9c;
            --primary-dark: #1a4b7a;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
        }
        
        body {
            background: #f0f5fa;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            padding: 24px;
            color: #1e293b;
        }
        
        .dashboard-wrapper {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Header */
        .header-card {
            background: white;
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-title i {
            font-size: 2rem;
            color: var(--primary);
            background: #e8f0fe;
            padding: 15px;
            border-radius: 16px;
        }
        
        .header-title h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: #1a4b7a;
        }
        
        .live-badge {
            background: #e8f7ed;
            color: #0b5e42;
            padding: 10px 20px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #a3e0b6;
        }
        
        .live-badge i {
            font-size: 0.7rem;
            color: #10b981;
        }
        
        /* Control Panel */
        .control-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        
        .control-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #1a4b7a;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .control-title i {
            color: var(--primary);
        }
        
        .district-selector {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            padding: 16px;
            background: #f8fafc;
            border-radius: 40px;
            border: 1px solid #e9ecef;
        }
        
        .selector-label {
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 140px;
        }
        
        .selector-label i {
            color: var(--primary);
        }
        
        .select2-container {
            width: 100% !important;
            max-width: 400px;
        }
        
        .btn-view {
            background: linear-gradient(135deg, #0f5b9c 0%, #1a4b7a 100%);
            border: none;
            padding: 10px 32px;
            font-weight: 500;
            border-radius: 40px;
            color: white;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(15, 91, 156, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .btn-view:hover {
            background: linear-gradient(135deg, #1a4b7a 0%, #0f5b9c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(15, 91, 156, 0.3);
        }
        
        .btn-view i {
            font-size: 1rem;
        }
        
        /* Status Filter */
        .status-filter-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 16px;
            background: #f8fafc;
            border-radius: 40px;
            border: 1px solid #e9ecef;
        }
        
        .status-filter-label {
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-filter-label i {
            color: var(--primary);
        }
        
        .status-filter-select {
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 8px 32px 8px 18px;
            background: white;
            font-size: 0.9rem;
            min-width: 200px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23334155' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 14px;
        }
        
        .status-filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(15, 91, 156, 0.1);
        }
        
        .btn-clear-status {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 8px 20px;
            color: #64748b;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-clear-status:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #ef4444;
        }
        
        .btn-clear-status i {
            margin-right: 6px;
        }
        
        /* Hidden Columns Dropdown */
        .hidden-columns-container {
            margin-bottom: 20px;
        }
        
        .dropdown-toggle-btn {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 40px;
            padding: 10px 24px;
            color: #1e293b;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        
        .dropdown-toggle-btn:hover {
            background: #f8fafc;
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .dropdown-toggle-btn i {
            transition: transform 0.2s;
        }
        
        .dropdown-toggle-btn.active i {
            transform: rotate(180deg);
        }
        
        .hidden-columns-panel {
            background: #f8fafc;
            border-radius: 20px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid #e9ecef;
            display: none;
        }
        
        .hidden-columns-panel.show {
            display: block;
        }
        
        .panel-title {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-title i {
            color: var(--primary);
        }
        
        .column-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .toggle-btn {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 8px 18px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-btn i {
            font-size: 0.8rem;
            color: #94a3b8;
        }
        
        .toggle-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .toggle-btn.active i {
            color: white;
        }
        
        .toggle-btn.highlight {
            border-color: var(--primary);
            background: #e8f0fe;
        }
        
        .export-btns {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 8px 22px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            background: white;
            transition: all 0.2s;
            text-decoration: none;
            color: #475569;
        }
        
        .export-btn.excel:hover {
            background: #e8f7ed;
            border-color: #10b981;
            color: #0b5e42;
        }
        
        .export-btn.pdf:hover {
            background: #fee9e7;
            border-color: #ef4444;
            color: #b91c1c;
        }
        
        .export-btn.csv:hover {
            background: #e8f0fe;
            border-color: var(--primary);
            color: var(--primary);
        }

        .export-btn.print:hover {
            background: #f1f4f9;
            border-color: #64748b;
            color: #1e293b;
        }
        
        /* Table Card */
        .table-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        
        /* Loading */
        .loading-wrapper {
            text-align: center;
            padding: 60px;
        }
        
        .spinner {
            width: 45px;
            height: 45px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        /* Table Styling */
        #mplsTable {
            margin-top: 10px !important;
            border: 1px solid #e9ecef;
            border-radius: 16px;
            overflow: hidden;
            width: 100%;
        }
        
        #mplsTable thead th {
            background: linear-gradient(135deg, #1a4b7a 0%, #1a4b7a 100%);
            color: white;
            font-weight: 500;
            font-size: 0.85rem;
            padding: 16px 12px;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        
        #mplsTable thead th:last-child {
            border-right: none;
        }
        
        #mplsTable tbody td {
            padding: 14px 12px;
            vertical-align: middle;
            border-bottom: 1px solid #edf2f7;
            color: #1e293b;
        }
        
        #mplsTable tbody tr:hover td {
            background: #f0f7ff;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 5px 14px;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .badge-completed {
            background: #e8f7ed;
            color: #0b5e42;
            border: 1px solid #a3e0b6;
        }
        
        .badge-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffe69c;
        }
        
        .badge-wip {
            background: #cff4fc;
            color: #055160;
            border: 1px solid #9eeaf9;
        }
        
        .badge-yes {
            background: #e8f7ed;
            color: #0b5e42;
            border: 1px solid #a3e0b6;
        }
        
        .badge-no {
            background: #fee9e7;
            color: #b91c1c;
            border: 1px solid #f1aeb5;
        }
        
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 20px;
        }
        
        .dataTables_filter input {
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 8px 16px 8px 38px;
            margin-left: 8px;
            outline: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 12px center;
        }
        
        .dataTables_filter input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(15, 91, 156, 0.1);
        }
        
        .dataTables_length select {
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 6px 25px 6px 12px;
        }
        
        .dataTables_info {
            color: #64748b;
            font-size: 0.9rem;
            padding-top: 15px;
        }
        
        .dataTables_paginate {
            margin-top: 20px;
        }
        
        .dataTables_paginate .paginate_button {
            border-radius: 30px;
            margin: 0 3px;
            border: 1px solid #e2e8f0;
            color: #1e293b !important;
        }
        
        .dataTables_paginate .paginate_button.current {
            background: var(--primary) !important;
            border-color: var(--primary) !important;
            color: white !important;
        }
        
        .dataTables_paginate .paginate_button:hover {
            background: #f1f5f9 !important;
            border-color: #cbd5e1 !important;
            color: var(--primary) !important;
        }
        
        .dt-buttons {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            body { padding: 16px; }
            .header-card { flex-direction: column; gap: 15px; }
            .district-selector { flex-direction: column; align-items: stretch; }
            .select2-container { max-width: 100%; }
            .export-btns { justify-content: center; }
            .status-filter-group { flex-direction: column; align-items: stretch; }
            .status-filter-select { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Header 
        <div class="header-card">
            <div class="header-title">
                <i class="bi bi-diagram-3"></i>
                <div>
                    <h1>MPLS District Wise View</h1>
                    <p class="text-muted mb-0 mt-1">Treasury MPLS VPN Status</p>
                </div>
            </div>
          
        </div> -->

        <!-- Controls -->
        <div class="control-card">
            <div class="control-title">
                <i class="bi bi-diagram-3"></i>
                <span>MPLS District Wise View</span> 
				<div class="live-badge" id="liveIndicator">
                <i class="bi bi-circle-fill"></i>
                <span>Ready</span>
            </div>
            </div>
             
            <!-- District Selector and Status Filter in Single Row -->
            <div class="d-flex align-items-center gap-3 flex-wrap mb-4">
                <!-- District Selector -->
                <div class="d-flex align-items-center gap-3 flex-grow-1">
                    <span class="fw-semibold text-nowrap">
                        <i class="bi bi-pin-map text-primary me-1"></i> MPLS District:
                    </span>
                    <select id="districtSelect" class="form-select" style="min-width: 250px;">
                        <option value="">Select a district</option>
                        <!-- Populated dynamically -->
                    </select>
                    <button id="viewDistrictBtn" class="btn-view text-nowrap">
                        <i class="bi bi-search"></i> View
                    </button>
                </div>
                
                <!-- Status Filter (initially hidden, shown after data loads) -->
                <div id="statusFilterContainer" class="d-flex align-items-center gap-3" style="display: none !important;">
                    <span class="fw-semibold text-nowrap">
                        <i class="bi bi-funnel text-primary me-1"></i> Status:
                    </span>
                    <select id="statusFilter" class="status-filter-select" style="min-width: 150px;">
                        <option value="">All</option>
                        <option value="Completed">Completed</option>
                        <option value="Pending">Pending</option>
                        <option value="WIP">WIP</option>
                    </select>
                    <button id="clearStatusFilter" class="btn-clear-status text-nowrap">
                        <i class="bi bi-x"></i> Clear
                    </button>
                </div>
            </div>
            
            <!-- Hidden Columns Dropdown -->
            <div class="hidden-columns-container mb-3">
                <button id="toggleHiddenColumns" class="dropdown-toggle-btn">
                    <i class="bi bi-chevron-down"></i>
                    <span>View Hidden Columns</span>
                    <span class="badge bg-primary rounded-pill ms-2" id="hiddenColumnsCount">0</span>
                </button>
                
                <div id="hiddenColumnsPanel" class="hidden-columns-panel">
                    <div class="panel-title">
                        <i class="bi bi-layout-three-columns"></i>
                        Click to show/hide additional columns:
                    </div>
                    <div class="column-toggles" id="columnToggles">
                        <!-- Dynamic toggles will appear here -->
                    </div>
                </div>
            </div>
            
            <div class="row align-items-center">
                <div class="col-lg-12">
                    <!-- Custom export buttons -->
                    <div class="export-btns" id="exportButtons">
                        <button class="export-btn excel" id="exportExcelBtn"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                        <button class="export-btn pdf" id="exportPdfBtn"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
                        <button class="export-btn csv" id="exportCsvBtn"><i class="bi bi-file-earmark-spreadsheet"></i> CSV</button>
                        <button class="export-btn print" id="exportPrintBtn"><i class="bi bi-printer"></i> Print</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Card -->
        <div class="table-card">
            <div id="loadingSpinner" class="loading-wrapper">
                <div class="spinner"></div>
                <p class="text-muted">Select a district and click View to load data...</p>
            </div>
            
            <div id="tableContainer" style="display: none;">
                <table id="mplsTable" class="table" style="width:100%">
                    <thead>
                        <tr>
                            <th>Sl.No</th>
                            <th>Order Type</th>
                            <th>BW</th>
                            <th>Order ID</th>
                            <th>Order Date</th>
                            <th>LC ID</th>
                            <th>Name of Treasury</th>
                            <th>BSNL TXN / TIP</th>
                            <th>LCO CODE</th>
                            <th>OLT IP</th>
                            <th>OUTER VLAN</th>
                            <th>WAN IP</th>
                            <th>VLAN</th>
                            <th>GATEWAY (BSNL)</th>
                            <th>GATEWAY (TREASURY)</th>
                            <th>Clarity order status</th>
                            <th>Status of work</th>
                            <th>Whether Commissioned</th>
                            <th>Final Comm. Date</th>
                            <th>Customer Acceptance Date</th>
                            <th>CONTACT DETAILS OF BSNL OFFIERS</th>
                            <th>Treasury Remarks</th>
                            <th>BBM REMARKS</th>
                            <th>Issue Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- LOCAL SCRIPTS -->
    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.bundle.min.js"></script>
    <script src="../js/select2.min.js"></script>
    
    <!-- DataTables Core -->
    <script src="../js/jquery.dataTables.min.js"></script>
    <script src="../js/dataTables.bootstrap5.min.js"></script>
    
    <!-- DataTables Buttons & Dependencies -->
    <script src="../js/dataTables.buttons.min.js"></script>
    <script src="../js/buttons.bootstrap5.min.js"></script>
    <script src="../js/jszip.min.js"></script>
    <script src="../js/pdfmake.min.js"></script>
    <script src="../js/vfs_fonts.js"></script>
    <script src="../js/buttons.html5.min.js"></script>
    <script src="../js/buttons.print.min.js"></script>

    <script>
        // ==================== CONFIGURATION ====================
        const API_KEY = 'AIzaSyBB1V3vJpNZ9X1GIF-YOwoa6YSt_iXMLo0';
        const SPREADSHEET_ID = '1gBqQucISIBob7EHXHMXU18ImxVivmjPY4bqP-FChPpQ';
        
        // District mapping: Actual Sheet Name -> Display Name
        const districtMapping = [
            { sheet: 'TVM', display: 'Trivandrum' },
            { sheet: 'KLM', display: 'Kollam' },
            { sheet: 'PTA', display: 'Pathanamthitta' },
            { sheet: 'KTM', display: 'Kottayam' },
            { sheet: 'ALP', display: 'Alappuzha' },
            { sheet: 'CLT', display: 'Calicut' },
            { sheet: 'EKM', display: 'Ernakulam' },
            { sheet: 'TRC', display: 'Thrissur' },
            { sheet: 'MLP', display: 'Malappuram' },
            { sheet: 'PGT', display: 'Palakkad' },
            { sheet: 'KNR', display: 'Kannur' }
        ];
        
        // Columns to show by default (indices based on the order in the table)
        // 6: Name of Treasury, 13: GATEWAY (BSNL), 14: GATEWAY (TREASURY), 
        // 16: Status of work, 20: BSNL Officers Contact, 21: Treasury Remarks,
        // 22: BBM REMARKS, 23: Issue Remarks
        const defaultVisibleColumns = [6, 13, 14, 16, 20, 21, 22, 23];
        
        // Global variables
        let currentDistrictData = [];
        let dataTable = null;
        let tableInitialized = false;
        
        // Column definitions (24 columns A-X)
        const columnDefs = [
            { title: 'Sl.No', data: 'slno', visible: defaultVisibleColumns.includes(0) },
            { title: 'Order Type', data: 'orderType', visible: defaultVisibleColumns.includes(1) },
            { title: 'BW', data: 'bw', visible: defaultVisibleColumns.includes(2) },
            { title: 'Order ID', data: 'orderId', visible: defaultVisibleColumns.includes(3) },
            { title: 'Order Date', data: 'orderDate', visible: defaultVisibleColumns.includes(4) },
            { title: 'LC ID', data: 'lcId', visible: defaultVisibleColumns.includes(5) },
            { title: 'Name of Treasury', data: 'treasury', visible: defaultVisibleColumns.includes(6) },
            { title: 'BSNL TXN / TIP', data: 'bsnlTxn', visible: defaultVisibleColumns.includes(7) },
            { title: 'LCO CODE', data: 'lcoCode', visible: defaultVisibleColumns.includes(8) },
            { title: 'OLT IP', data: 'oltIp', visible: defaultVisibleColumns.includes(9) },
            { title: 'OUTER VLAN', data: 'outerVlan', visible: defaultVisibleColumns.includes(10) },
            { title: 'WAN IP', data: 'wanIp', visible: defaultVisibleColumns.includes(11) },
            { title: 'VLAN', data: 'vlan', visible: defaultVisibleColumns.includes(12) },
            { title: 'GATEWAY (BSNL)', data: 'gatewayBSNL', visible: defaultVisibleColumns.includes(13) },
            { title: 'GATEWAY (TREASURY)', data: 'gatewayTreasury', visible: defaultVisibleColumns.includes(14) },
            { title: 'Clarity order status', data: 'clarityStatus', visible: defaultVisibleColumns.includes(15) },
            { title: 'Status of work', data: 'workStatus', visible: defaultVisibleColumns.includes(16) },
            { title: 'Whether Commissioned', data: 'commissioned', visible: defaultVisibleColumns.includes(17) },
            { title: 'Final Comm. Date', data: 'finalCommDate', visible: defaultVisibleColumns.includes(18) },
            { title: 'Customer Acceptance Date', data: 'acceptanceDate', visible: defaultVisibleColumns.includes(19) },
            { title: 'CONTACT DETAILS OF BSNL OFFIERS', data: 'bsnlContact', visible: defaultVisibleColumns.includes(20) },
            { title: 'Treasury Remarks', data: 'treasuryRemarks', visible: defaultVisibleColumns.includes(21) },
            { title: 'BBM REMARKS', data: 'bbmRemarks', visible: defaultVisibleColumns.includes(22) },
            { title: 'Issue Remarks', data: 'issueRemarks', visible: defaultVisibleColumns.includes(23) }
        ];

        // ==================== INITIALIZATION ====================
        $(document).ready(function() {
            console.log('Document ready');
            
            // Populate district dropdown
            populateDistrictDropdown();
            
            // Initialize Select2
            $('#districtSelect').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: 'Search or select district',
                allowClear: true
            });

            // View button click
            $('#viewDistrictBtn').on('click', function() {
                const selectedSheet = $('#districtSelect').val();
                if (!selectedSheet) {
                    alert('Please select a district');
                    return;
                }
                loadDistrictData(selectedSheet);
            });

            // Export button listeners
            $('#exportExcelBtn').on('click', function() { 
                if (dataTable) $('.buttons-excel').first().trigger('click'); 
            });
            $('#exportPdfBtn').on('click', function() { 
                if (dataTable) $('.buttons-pdf').first().trigger('click'); 
            });
            $('#exportCsvBtn').on('click', function() { 
                if (dataTable) $('.buttons-csv').first().trigger('click'); 
            });
            $('#exportPrintBtn').on('click', function() { 
                if (dataTable) $('.buttons-print').first().trigger('click'); 
            });

            // Status filter change
            $('#statusFilter').on('change', function() {
                if (dataTable) {
                    const searchValue = this.value;
                    // Column 16 (0-indexed) is Status of work
                    dataTable.column(16).search(searchValue).draw();
                }
            });

            // Clear status filter
            $('#clearStatusFilter').on('click', function() {
                $('#statusFilter').val('');
                if (dataTable) {
                    dataTable.column(16).search('').draw();
                }
            });
            
            // Toggle hidden columns panel
            $('#toggleHiddenColumns').on('click', function() {
                $('#hiddenColumnsPanel').toggleClass('show');
                $(this).toggleClass('active');
            });
        });

        function populateDistrictDropdown() {
            const $select = $('#districtSelect');
            $select.empty().append('<option value="">Select a district</option>');
            
            districtMapping.forEach(item => {
                $select.append(`<option value="${item.sheet}">${item.display}</option>`);
            });
        }

        async function loadDistrictData(sheetName) {
            try {
                showLoading(true);
                $('#statusFilterContainer').hide(); // Hide initially
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
                console.log('Fetching from:', url);
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('Data received:', data);
                
                if (!data.values || data.values.length < 2) {
                    throw new Error('No data rows found');
                }

                processData(data.values);
                updateLiveIndicator(sheetName);
                initializeTable();
                createColumnToggles();
                updateHiddenColumnsCount();
                
                // Show status filter after data loads
                $('#statusFilterContainer').show();
                showLoading(false);
                
            } catch (error) {
                console.error('Error:', error);
                $('#loadingSpinner').html(`
                    <i class="bi bi-exclamation-triangle-fill fa-3x text-danger mb-3"></i>
                    <h5 class="text-danger">Failed to load data</h5>
                    <p class="text-muted">${error.message}</p>
                    <button class="btn btn-primary mt-3" onclick="location.reload()">
                        <i class="bi bi-arrow-repeat"></i> Retry
                    </button>
                `);
            }
        }

        function processData(rows) {
            currentDistrictData = [];
            
            // Skip header row (index 0)
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 5) continue;
                
                // Pad row to have 24 columns
                while (row.length < 24) row.push('');
                
                currentDistrictData.push({
                    slno: row[0] || '',
                    orderType: row[1] || '',
                    bw: row[2] || '',
                    orderId: row[3] || '',
                    orderDate: row[4] || '',
                    lcId: row[5] || '',
                    treasury: row[6] || '',
                    bsnlTxn: row[7] || '',
                    lcoCode: row[8] || '',
                    oltIp: row[9] || '',
                    outerVlan: row[10] || '',
                    wanIp: row[11] || '',
                    vlan: row[12] || '',
                    gatewayBSNL: row[13] || '',
                    gatewayTreasury: row[14] || '',
                    clarityStatus: row[15] || '',
                    workStatus: row[16] || '',
                    commissioned: row[17] || '',
                    finalCommDate: row[18] || '',
                    acceptanceDate: row[19] || '',
                    bsnlContact: row[20] || '',
                    treasuryRemarks: row[21] || '',
                    bbmRemarks: row[22] || '',
                    issueRemarks: row[23] || ''
                });
            }
            
            console.log(`Processed ${currentDistrictData.length} records`);
        }

        function initializeTable() {
            if (dataTable) {
                dataTable.destroy();
                dataTable = null;
            }

            const tableData = currentDistrictData.map(item => [
                item.slno,
                item.orderType,
                item.bw,
                item.orderId,
                item.orderDate,
                item.lcId,
                item.treasury,
                item.bsnlTxn,
                item.lcoCode,
                item.oltIp,
                item.outerVlan,
                item.wanIp,
                item.vlan,
                item.gatewayBSNL,
                item.gatewayTreasury,
                item.clarityStatus,
                item.workStatus,
                item.commissioned,
                item.finalCommDate,
                item.acceptanceDate,
                item.bsnlContact,
                item.treasuryRemarks,
                item.bbmRemarks,
                item.issueRemarks
            ]);

            dataTable = $('#mplsTable').DataTable({
                data: tableData,
                columns: columnDefs.map((col, idx) => ({
                    title: col.title,
                    visible: col.visible,
                    render: function(data, type, row) {
                        if (type === 'display') {
                            if (idx === 16) { // Status of work
                                const status = data.toLowerCase();
                                if (status.includes('completed')) {
                                    return `<span class="status-badge badge-completed"><i class="bi bi-check-circle-fill me-1"></i>${data}</span>`;
                                } else if (status.includes('pending')) {
                                    return `<span class="status-badge badge-pending"><i class="bi bi-clock-fill me-1"></i>${data}</span>`;
                                } else if (status.includes('wip')) {
                                    return `<span class="status-badge badge-wip"><i class="bi bi-gear-fill me-1"></i>${data}</span>`;
                                }
                                return data;
                            }
                            else if (idx === 17) { // Whether Commissioned
                                const val = data.toString().toUpperCase();
                                if (val === 'YES') {
                                    return `<span class="status-badge badge-yes"><i class="bi bi-check-circle-fill me-1"></i>${data}</span>`;
                                } else if (val === 'NO') {
                                    return `<span class="status-badge badge-no"><i class="bi bi-x-circle-fill me-1"></i>${data}</span>`;
                                }
                                return data;
                            }
                        }
                        return data;
                    }
                })),
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                order: [[0, 'asc']],
                dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>rtip',
                buttons: [
                    { 
                        extend: 'excelHtml5', 
                        text: 'Excel', 
                        className: 'btn btn-sm buttons-excel',
                        title: 'MPLS_District_Data',
                        exportOptions: { 
                            columns: ':visible', 
                            format: { 
                                body: function(data) {
                                    return $('<div>').html(data).text().trim() || data;
                                }
                            } 
                        } 
                    },
                    { 
                        extend: 'pdfHtml5', 
                        text: 'PDF', 
                        className: 'btn btn-sm buttons-pdf', 
                        orientation: 'landscape', 
                        pageSize: 'A4',
                        title: 'MPLS_District_Data',
                        exportOptions: { 
                            columns: ':visible', 
                            format: { 
                                body: function(data) {
                                    return $('<div>').html(data).text().trim() || data;
                                }
                            } 
                        } 
                    },
                    { 
                        extend: 'csvHtml5', 
                        text: 'CSV', 
                        className: 'btn btn-sm buttons-csv',
                        title: 'MPLS_District_Data',
                        exportOptions: { 
                            columns: ':visible', 
                            format: { 
                                body: function(data) {
                                    return $('<div>').html(data).text().trim() || data;
                                }
                            } 
                        } 
                    },
                    { 
                        extend: 'print', 
                        text: 'Print', 
                        className: 'btn btn-sm buttons-print', 
                        title: 'MPLS District Data',
                        exportOptions: { 
                            columns: ':visible', 
                            format: { 
                                body: function(data) {
                                    return $('<div>').html(data).text().trim() || data;
                                }
                            } 
                        } 
                    }
                ],
                language: {
                    search: "Search:",
                    searchPlaceholder: "Filter records...",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "Showing 0 to 0 of 0 entries",
                    infoFiltered: "(filtered from _MAX_ total entries)",
                    paginate: {
                        first: '<i class="bi bi-chevron-double-left"></i>',
                        previous: '<i class="bi bi-chevron-left"></i>',
                        next: '<i class="bi bi-chevron-right"></i>',
                        last: '<i class="bi bi-chevron-double-right"></i>'
                    }
                }
            });

            tableInitialized = true;
            console.log('Table initialized');
        }

        function createColumnToggles() {
            const container = $('#columnToggles');
            container.empty();
            
            columnDefs.forEach((col, index) => {
                // Check if this is a default visible column
                const isDefaultVisible = defaultVisibleColumns.includes(index);
                
                const btn = $(`
                    <span class="toggle-btn ${isDefaultVisible ? 'active highlight' : ''}" data-col="${index}">
                        <i class="bi ${isDefaultVisible ? 'bi-check-circle-fill' : 'bi-circle'}"></i> ${col.title}
                    </span>
                `);
                
                btn.click(function() {
                    if (dataTable) {
                        const column = dataTable.column(index);
                        const visible = column.visible();
                        column.visible(!visible);
                        
                        if ($(this).hasClass('active')) {
                            $(this).removeClass('active');
                            $(this).find('i').removeClass('bi-check-circle-fill').addClass('bi-circle');
                        } else {
                            $(this).addClass('active');
                            $(this).find('i').removeClass('bi-circle').addClass('bi-check-circle-fill');
                        }
                        
                        // Update hidden columns count
                        updateHiddenColumnsCount();
                    }
                });
                container.append(btn);
            });
        }
        
        function updateHiddenColumnsCount() {
            if (!dataTable) return;
            
            let hiddenCount = 0;
            columnDefs.forEach((col, index) => {
                const column = dataTable.column(index);
                if (!column.visible()) {
                    hiddenCount++;
                }
            });
            
            $('#hiddenColumnsCount').text(hiddenCount);
        }

        function updateLiveIndicator(sheetName) {
            const displayName = districtMapping.find(item => item.sheet === sheetName)?.display || sheetName;
            $('#liveIndicator').html(`
                <i class="bi bi-circle-fill" style="color:#10b981;"></i>
                <span>${displayName} Â· Updated ${new Date().toLocaleTimeString()}</span>
            `);
        }

        function showLoading(show) {
            if (show) {
                $('#loadingSpinner').show();
                $('#tableContainer').hide();
            } else {
                $('#loadingSpinner').hide();
                $('#tableContainer').show();
            }
        }
    </script>

</body>
</html>